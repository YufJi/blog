<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>小程序事件系统 | YufJ&#39;s Daily</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/blog/icons/icon.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/icons/icon.png">
    <meta name="description" content="记录自己的刷题之旅和分享">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#F3F3F3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="msapplication-TileImage" content="/icons/icon.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.e05e9135.css" as="style"><link rel="preload" href="/blog/assets/js/app.97a09ff6.js" as="script"><link rel="preload" href="/blog/assets/js/2.ff78d0ce.js" as="script"><link rel="preload" href="/blog/assets/js/9.d7416083.js" as="script"><link rel="preload" href="/blog/assets/js/5.2d578415.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.c4e51aaa.js"><link rel="prefetch" href="/blog/assets/js/11.b1ae3f0e.js"><link rel="prefetch" href="/blog/assets/js/12.1e947321.js"><link rel="prefetch" href="/blog/assets/js/13.bb04cdfc.js"><link rel="prefetch" href="/blog/assets/js/14.de559b4a.js"><link rel="prefetch" href="/blog/assets/js/15.12989066.js"><link rel="prefetch" href="/blog/assets/js/16.843d0225.js"><link rel="prefetch" href="/blog/assets/js/17.44272a29.js"><link rel="prefetch" href="/blog/assets/js/18.a24315dd.js"><link rel="prefetch" href="/blog/assets/js/19.4698954f.js"><link rel="prefetch" href="/blog/assets/js/20.63afe0bd.js"><link rel="prefetch" href="/blog/assets/js/21.196aa8a2.js"><link rel="prefetch" href="/blog/assets/js/22.1b00eb4b.js"><link rel="prefetch" href="/blog/assets/js/23.ecc0a46f.js"><link rel="prefetch" href="/blog/assets/js/24.367af783.js"><link rel="prefetch" href="/blog/assets/js/25.8bfcf3b1.js"><link rel="prefetch" href="/blog/assets/js/26.cede6143.js"><link rel="prefetch" href="/blog/assets/js/27.9fcc3475.js"><link rel="prefetch" href="/blog/assets/js/28.f3bf0925.js"><link rel="prefetch" href="/blog/assets/js/29.05fb8d17.js"><link rel="prefetch" href="/blog/assets/js/3.ecc0702e.js"><link rel="prefetch" href="/blog/assets/js/30.6a75fa4d.js"><link rel="prefetch" href="/blog/assets/js/31.73d565ab.js"><link rel="prefetch" href="/blog/assets/js/32.b17a3050.js"><link rel="prefetch" href="/blog/assets/js/33.4c3ad177.js"><link rel="prefetch" href="/blog/assets/js/34.6463c770.js"><link rel="prefetch" href="/blog/assets/js/35.2e68cbe7.js"><link rel="prefetch" href="/blog/assets/js/36.d701b3e1.js"><link rel="prefetch" href="/blog/assets/js/37.6795bf14.js"><link rel="prefetch" href="/blog/assets/js/38.d71739c4.js"><link rel="prefetch" href="/blog/assets/js/39.6616a5ef.js"><link rel="prefetch" href="/blog/assets/js/4.42aeb94e.js"><link rel="prefetch" href="/blog/assets/js/40.f3a6d96e.js"><link rel="prefetch" href="/blog/assets/js/41.6455b83f.js"><link rel="prefetch" href="/blog/assets/js/42.0cf8ddb2.js"><link rel="prefetch" href="/blog/assets/js/43.64663163.js"><link rel="prefetch" href="/blog/assets/js/44.7e32b8b6.js"><link rel="prefetch" href="/blog/assets/js/45.419d6336.js"><link rel="prefetch" href="/blog/assets/js/46.ffc8ca4f.js"><link rel="prefetch" href="/blog/assets/js/47.6f3ef3e4.js"><link rel="prefetch" href="/blog/assets/js/48.17351e90.js"><link rel="prefetch" href="/blog/assets/js/49.bd498107.js"><link rel="prefetch" href="/blog/assets/js/50.64d8bff6.js"><link rel="prefetch" href="/blog/assets/js/51.269419de.js"><link rel="prefetch" href="/blog/assets/js/52.47da2b03.js"><link rel="prefetch" href="/blog/assets/js/53.e7fd50e8.js"><link rel="prefetch" href="/blog/assets/js/54.df2dc67a.js"><link rel="prefetch" href="/blog/assets/js/55.19ea6786.js"><link rel="prefetch" href="/blog/assets/js/6.854148ae.js"><link rel="prefetch" href="/blog/assets/js/7.fa17fc74.js"><link rel="prefetch" href="/blog/assets/js/8.b08f96d5.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.e05e9135.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">YufJ's Daily</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>小程序</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/Tiny/JSBridge.html" class="sidebar-link">小程序中JSBridge的实现</a></li><li><a href="/blog/Tiny/event.html" aria-current="page" class="active sidebar-link">小程序事件系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/Tiny/event.html#介绍" class="sidebar-link">介绍</a></li><li class="sidebar-sub-header"><a href="/blog/Tiny/event.html#探索" class="sidebar-link">探索</a></li><li class="sidebar-sub-header"><a href="/blog/Tiny/event.html#实践" class="sidebar-link">实践</a></li><li class="sidebar-sub-header"><a href="/blog/Tiny/event.html#最终效果" class="sidebar-link">最终效果</a></li><li class="sidebar-sub-header"><a href="/blog/Tiny/event.html#反思" class="sidebar-link">反思</a></li><li class="sidebar-sub-header"><a href="/blog/Tiny/event.html#参考资料" class="sidebar-link">参考资料</a></li></ul></li><li><a href="/blog/Tiny/miniapp.html" class="sidebar-link">关于小程序的探索</a></li><li><a href="/blog/Tiny/自定义组件web-component化.html" class="sidebar-link">自定义组件web-component化</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="小程序事件系统"><a href="#小程序事件系统" class="header-anchor">#</a> 小程序事件系统</h1> <h2 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h2> <p>小程序中提供了一套自定义的事件系统， 事件支持有<strong>tap</strong>、<strong>longpress</strong>、<strong>touchstart</strong>、<strong>touchmove</strong>、<strong>touchend</strong>、<strong>touchcancel</strong>...， 支持<strong>捕获阶段</strong>、<strong>冒泡阶段</strong>、互斥事件等。</p> <p>在使用方式上小程序的事件采用的是标签指令的方式：如</p> <div class="language-html extra-class"><pre class="language-html"><code>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">bindtap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{{handleTap}}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>我是一个文本<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">catchtap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{{handleTap}}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>我是一个文本<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name"><span class="token namespace">capture-bind:</span>tap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{{handleTap}}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>我是一个文本<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><p>从上面的使用方式可以看出，一个事件绑定指令中，会包含这些信息： <strong>事件名</strong>、<strong>事件阶段</strong>、<strong>是否冒泡</strong>等，虽然小程序的事件与现代浏览器中支持的事件很类似，但支持了tap、longpress这些浏览器中没有内置的事件，如何实现这样一套小程序事件系统呢。</p> <h2 id="探索"><a href="#探索" class="header-anchor">#</a> 探索</h2> <p>抛出问题：</p> <ul><li>A1: tap、longpress的实现</li> <li>A2: 这样的事件系统如果在react这样的库中实现
</li></ul> <p>Q1: 如果了解zepto的同学肯定很快就能大概知道tap、longpress事件的实现原理，基于touch事件的四个阶段就可以很好的实现。</p> <p>Q2: 由于react的诞生初衷就是write once run everywhere，我们常用的react-dom是react针对浏览器环境的一个渲染器，react-dom、react-native这些适配器中都会依赖react的核心协调器react-reconciler，因此我们可以基于react-reconciler实现一个小程序渲染层的渲染器，实现对小程序的事件系统的支持。</p> <h2 id="实践"><a href="#实践" class="header-anchor">#</a> 实践</h2> <p>开始实现自定义渲染器，由于自定义渲染器的实现不是很重要，有很多案例比如Remax中就有，可自行查阅。</p> <p>下面主要详细介绍事件这部分的处理, 由于react的构建时babel插件的语法限制，不支持bind:tap这种带‘:’的jsx写法会有警告（虽然&quot;throwIfNamespace&quot;: false可以关闭）, 我们这里默认在运行时拿到的prop都是不带‘:’, 编译时会处理掉。</p> <p>1、处理event prop，在事件回调保存在dom</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> eventReg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(capture-)?(bind|catch)([A-Za-z_]+)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">isAnEvent</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>eventReg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">patchEvent</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span> lastEvent<span class="token punctuation">,</span> nextEvent<span class="token punctuation">,</span> domNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> raw<span class="token punctuation">,</span> name<span class="token punctuation">,</span> options <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">toEventName</span><span class="token punctuation">(</span>eventName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> capture <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>

  <span class="token keyword">const</span> listener <span class="token operator">=</span> domNode<span class="token punctuation">.</span>_listeners <span class="token operator">||</span> <span class="token punctuation">(</span>domNode<span class="token punctuation">.</span>_listeners <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>nextEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    listener<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> listener<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lastEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">eventProxy</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>domNode<span class="token punctuation">,</span> name<span class="token punctuation">,</span> capture<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 事件绑定</span>
      <span class="token function">addListener</span><span class="token punctuation">(</span>domNode<span class="token punctuation">,</span> name<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> displayName <span class="token operator">=</span> nextEvent<span class="token punctuation">.</span>name<span class="token punctuation">;</span>

    listener<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>capture <span class="token operator">?</span> <span class="token string">'capture'</span> <span class="token operator">:</span> <span class="token string">'bubble'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      options<span class="token punctuation">,</span>
      handler<span class="token operator">:</span> nextEvent<span class="token punctuation">,</span>
      name<span class="token operator">:</span> displayName<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    domNode<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> displayName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 回收事件</span>
    listener<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>capture <span class="token operator">?</span> <span class="token string">'capture'</span> <span class="token operator">:</span> <span class="token string">'bubble'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    domNode<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">toEventName</span><span class="token punctuation">(</span><span class="token parameter">prop</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> matches <span class="token operator">=</span> prop<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>eventReg<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> capture <span class="token operator">=</span> matches<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'capture-'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> stop <span class="token operator">=</span> matches<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'catch'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> matches<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> capture<span class="token punctuation">,</span> stop <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    raw<span class="token operator">:</span> prop<span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    options<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>2、 格式化包装event对象，并且处理是否阻止冒泡</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">eventProxy</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> capture<span class="token punctuation">,</span> nativeEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">EVENT_BLACK_LIST</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> canBubble <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> listener <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_listeners<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>capture <span class="token operator">?</span> <span class="token string">'capture'</span> <span class="token operator">:</span> <span class="token string">'bubble'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>listener<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> event <span class="token operator">=</span> <span class="token function">wrapEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> nativeEvent<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 处理冒泡</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>listener<span class="token punctuation">.</span>options<span class="token punctuation">.</span>stop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    nativeEvent<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nativeEvent<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    canBubble <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  listener<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> canBubble<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 格式化event</span>
<span class="token keyword">function</span> <span class="token function">wrapEvent</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> nativeEvent<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> targetElement <span class="token operator">=</span> nativeEvent<span class="token punctuation">.</span>target<span class="token punctuation">;</span>

  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> targetElement<span class="token punctuation">.</span>id <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
    dataset<span class="token operator">:</span> targetElement<span class="token punctuation">.</span>_dataset <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> currentTarget <span class="token operator">=</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> node<span class="token punctuation">.</span>id <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
    dataset<span class="token operator">:</span> node<span class="token punctuation">.</span>_dataset <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">,</span>
    timeStamp<span class="token operator">:</span> nativeEvent<span class="token punctuation">.</span>timeStamp<span class="token punctuation">,</span>
    target<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>target<span class="token punctuation">,</span>
      offsetLeft<span class="token operator">:</span> targetElement<span class="token punctuation">.</span>offsetLeft <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span>
      offsetTop<span class="token operator">:</span> targetElement<span class="token punctuation">.</span>offsetTop <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    currentTarget<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>currentTarget<span class="token punctuation">,</span>
      offsetLeft<span class="token operator">:</span> node<span class="token punctuation">.</span>offsetLeft <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span>
      offsetTop<span class="token operator">:</span> node<span class="token punctuation">.</span>offsetTop <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    detail<span class="token operator">:</span> nativeEvent<span class="token punctuation">.</span>detail<span class="token punctuation">,</span>
    touches<span class="token operator">:</span> <span class="token function">getTouches</span><span class="token punctuation">(</span>nativeEvent<span class="token punctuation">.</span>touches<span class="token punctuation">)</span><span class="token punctuation">,</span>
    changedTouches<span class="token operator">:</span> <span class="token function">getTouches</span><span class="token punctuation">(</span>nativeEvent<span class="token punctuation">.</span>changedTouches<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>3、事件绑定</p> <p>由于tap和longpress事件是由touch模拟的，所以在事件绑定时这两个事件所在的dom只需要执行一次touch四个阶段的绑定, 模拟tap事件注册时的touch事件都使用冒泡阶段</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// dom 事件名 绑定事件</span>
<span class="token keyword">function</span> <span class="token function">addListener</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> type<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> capture <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>eventType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'tap'</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">.</span>__hasTapEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          node<span class="token punctuation">.</span>__hasTapEvent <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token function">addTapEvent</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'tiny-tap'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> capture<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token string">'longtap'</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token string">'longpress'</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">.</span>__hasTapEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          node<span class="token punctuation">.</span>__hasTapEvent <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token function">addTapEvent</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'tiny-longpress'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          e<span class="token punctuation">.</span><span class="token function">longpressFired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> capture<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">addTapEvent</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> pressTimer<span class="token punctuation">;</span>
  <span class="token keyword">let</span> pressStart<span class="token punctuation">;</span>
  <span class="token keyword">let</span> ended<span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">touchstartHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 解决tap事件多次调用的问题</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>__handledTap<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    ended <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    pressStart <span class="token operator">=</span> <span class="token punctuation">{</span>
      x<span class="token operator">:</span> e<span class="token punctuation">.</span>touches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pageX<span class="token punctuation">,</span>
      y<span class="token operator">:</span> e<span class="token punctuation">.</span>touches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pageY<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>pressTimer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pressTimer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 触发长按时间</span>
      <span class="token keyword">const</span> pressEvent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>elementPrefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-longpress</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        bubbles<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        composed<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      pressEvent<span class="token punctuation">.</span>detail <span class="token operator">=</span> pressStart<span class="token punctuation">;</span>

      <span class="token comment">// 由回调执行设置结束，防止回调未执行成功</span>
      pressEvent<span class="token punctuation">.</span><span class="token function-variable function">longpressFired</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ended <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      node<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>pressEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">PRESS_DELAY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    e<span class="token punctuation">.</span>__handledTap <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 主要用来判断tap结束和取消长按计时</span>
  <span class="token keyword">const</span> <span class="token function-variable function">touchmoveHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ended <span class="token operator">||</span> <span class="token operator">!</span>pressStart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> dx <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>changedTouches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pageX <span class="token operator">-</span> pressStart<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> dy <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>changedTouches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pageY <span class="token operator">-</span> pressStart<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>dx <span class="token operator">&gt;</span> <span class="token constant">TAP_DISTANCE</span> <span class="token operator">||</span> dy <span class="token operator">&gt;</span> <span class="token constant">TAP_DISTANCE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ended <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token function">clearTimeout</span><span class="token punctuation">(</span>pressTimer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">touchendHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ended <span class="token operator">||</span> <span class="token operator">!</span>pressStart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ended <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>pressTimer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果没有触发touchmove的判断，这里还要再来一下</span>
    <span class="token keyword">const</span> dx <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>changedTouches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pageX <span class="token operator">-</span> pressStart<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> dy <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>changedTouches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pageY <span class="token operator">-</span> pressStart<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>dx <span class="token operator">&gt;</span> <span class="token constant">TAP_DISTANCE</span> <span class="token operator">||</span> dy <span class="token operator">&gt;</span> <span class="token constant">TAP_DISTANCE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// dispatch tap event</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>disabled <span class="token operator">&amp;&amp;</span> <span class="token constant">TAP_BLACK_LIST</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>tagName<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// if element is disabled, 那就不触发了</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> tapEvent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>elementPrefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-tap</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      bubbles<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      composed<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    tapEvent<span class="token punctuation">.</span>detail <span class="token operator">=</span> <span class="token punctuation">{</span>
      x<span class="token operator">:</span> e<span class="token punctuation">.</span>changedTouches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pageX<span class="token punctuation">,</span>
      y<span class="token operator">:</span> e<span class="token punctuation">.</span>changedTouches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pageY<span class="token punctuation">,</span>
      sourceEndEvent<span class="token operator">:</span> e<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    node<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>tapEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">touchcancelHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ended <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>pressTimer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'touchstart'</span><span class="token punctuation">,</span> touchstartHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'touchmove'</span><span class="token punctuation">,</span> touchmoveHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'touchend'</span><span class="token punctuation">,</span> touchendHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'touchcancel'</span><span class="token punctuation">,</span> touchcancelHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="最终效果"><a href="#最终效果" class="header-anchor">#</a> 最终效果</h2> <p>如下这样一段小程序代码，分别在react和微信中的执行结果表现一致</p> <p>react模版</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tiny-view</span>
      <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>parent<span class="token punctuation">&quot;</span></span>
      <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">background</span><span class="token punctuation">:</span> green<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span>
      <span class="token attr-name">capture-bindtap</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent capture tap'</span><span class="token punctuation">,</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token punctuation">}</span></span>
      <span class="token attr-name">bindtap</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent tap'</span><span class="token punctuation">,</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token punctuation">}</span></span>
      <span class="token attr-name">bindtouchstart</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent touchstart'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span>
      <span class="token attr-name">bindtouchmove</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent touchmove'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span>
    <span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tiny-view</span>
        <span class="token attr-name">capture-bindtap</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'component capture tap'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span>
        <span class="token attr-name">catchtap</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'component catch tap'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span>
        <span class="token attr-name">bindlongpress</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'component longpress'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span>
        <span class="token attr-name">bindtouchstart</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'component touchstart'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span>
        <span class="token attr-name">catchtouchmove</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'component touchmove'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span>
      <span class="token punctuation">&gt;</span></span><span class="token plain-text">
        longpress/tap component
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tiny-view</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tiny-view</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>小程序模版</p> <div class="language-html extra-class"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span>
    <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>parent<span class="token punctuation">&quot;</span></span>
    <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">background</span><span class="token punctuation">:</span> green<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span>
    <span class="token attr-name"><span class="token namespace">capture-bind:</span>tap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pct<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">bindtap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">bindtouchstart</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pts<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">bindtouchmove</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ptm<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span>
      <span class="token attr-name"><span class="token namespace">capture-bind:</span>tap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cct<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">catchtap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ct<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">bindtouchstart</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cts<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">catchtouchmove</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ctm<span class="token punctuation">&quot;</span></span>
    <span class="token punctuation">&gt;</span></span>
      longpress/tap component
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><img src="/blog/assets/img/事件系统.6423f061.png" width="1080"> <h2 id="反思"><a href="#反思" class="header-anchor">#</a> 反思</h2> <p>其实这样的事件实现有一个bug存在，由于tap是通过touch来模拟的，当我们给某个标签同时绑定了touchstart和tap捕获、冒泡事件时，触发顺序是这样的：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>touchstart
capture tap
tap
</code></pre></div><p>很明显的问题touchstart在tap捕获之前执行了...（这个问题微信小程序同样存在）</p> <h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h2> <ul><li><a href="https://microapp.bytedance.com/docs/zh-CN/mini-app/develop/developer-instrument/overview" target="_blank" rel="noopener noreferrer">字节小程序基础库<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/facebook/react/tree/main/packages/react-reconciler" target="_blank" rel="noopener noreferrer">react-reconciler<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/NervJS/nerv/tree/master/packages/nerv" target="_blank" rel="noopener noreferrer">nervjs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/EventTarget/addEventListener" target="_blank" rel="noopener noreferrer">浏览器事件注册<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/CustomEvent" target="_blank" rel="noopener noreferrer">浏览器自定义事件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/Tiny/JSBridge.html" class="prev">
        小程序中JSBridge的实现
      </a></span> <span class="next"><a href="/blog/Tiny/miniapp.html">
        关于小程序的探索
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.97a09ff6.js" defer></script><script src="/blog/assets/js/2.ff78d0ce.js" defer></script><script src="/blog/assets/js/9.d7416083.js" defer></script><script src="/blog/assets/js/5.2d578415.js" defer></script>
  </body>
</html>
